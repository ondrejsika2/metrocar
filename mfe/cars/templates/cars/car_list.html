{% extends "base.html" %}

{% load i18n thumbnail car_maps %}

{% block extra_css_overload %}
<link rel="stylesheet" href="{{ MEDIA_URL }}css/themes/smoothness/jquery-ui-1.8rc3.custom.css" type="text/css" />
<link rel="stylesheet" href="{{ MEDIA_URL }}css/jquery.tooltip.css" type="text/css" />
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="{{ MEDIA_URL}}js/jquery.tooltip.pack.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-ui-1.8rc3.custom.min.js"></script>
<script src="{{ MEDIA_URL }}js/OpenLayers-2.8/OpenLayers.js" type="text/javascript"></script>
<script src="{{ MEDIA_URL }}js/prototypes.js" type="text/javascript"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/map-client/OSMPOI.js"></script>
<script type="text/javascript">
/* based on the GeoExt tree example, Copyright (c) 2008-2009 The Open Source Geospatial Foundation */

var base_url = '/static/';

var wgs84 = new OpenLayers.Projection("EPSG:4326");
var smerc = new OpenLayers.Projection("EPSG:900913");

var mapPanel, map;
var canCloseSearchResults = true;
var selectCtrl, popup;

var overlays = [];

function initializeMap() {
	OpenLayers.ImgPath = "{{ MEDIA_URL }}js/OpenLayers-2.8/theme/dark/";
    map = new OpenLayers.Map.cdauth("car-map",{
        allOverlays: false,
        controls: [
            new OpenLayers.Control.Navigation(),
            new OpenLayers.Control.PanZoomBar(),
            new OpenLayers.Control.KeyboardDefaults()
        ],
        projection: smerc,
        displayProjection: wgs84,
        maxExtent: new OpenLayers.Bounds(-180, -90, 180, 90).transform(wgs84,smerc),
        numZoomLevels: 19,
    });
    layers = [
        new OpenLayers.Layer.cdauth.OSM.Mapnik("Mapnik"),
        new OpenLayers.Layer.cdauth.OSM.CycleMap("CycleMap"),
        new OpenLayers.Layer.cdauth.OSM.Osmarender("Osmarender"),
    ];

    map.addLayers(layers);
    map.addLayers(overlays);

	var geoLocationControl = new OpenLayers.Control.cdauth.GeoLocation();
	map.addControl(geoLocationControl);

    // Keep location.hash up to date with the current map view to provide a Permalink there. Also save the current view in a cookie.
    var hashHandler = new OpenLayers.Control.cdauth.URLHashHandler();
    map.addControl(hashHandler);
	if(hashHandler.hashHandler.getLocationHash() == "")
	{ // No Permalink has been called, use GeoLocation support
		geoLocationControl.goToGeoLocation();
	}
    if(hashHandler.hashHandler.getLocationHash() == "")
    { // Still no Permalink, use the one from the cookie (if GeoLocation works, the position might be changed to that later)
        var cookies = document.cookie.split(/;\s*/);
        for(var i=0; i<cookies.length; i++)
        {
            var equalp = cookies[i].indexOf("=");
            if(equalp == -1) continue;
            var cookie = [ cookies[i].substr(0, equalp), cookies[i].substr(equalp+1) ];
            if(cookie[0] == "osmview")
            {
                location.hash = "#"+cookie[1].replace(/&/g, ";");
                break;
            }
        }
    }
    if(hashHandler.hashHandler.getLocationHash() == "")
    { // Still no Permalink, use default values
        location.hash = "#lon=10.5;lat=51.3;zoom=5";
    }
    var cookieExpiry = new Date();
    cookieExpiry.setYear(cookieExpiry.getFullYear() + 10);
    hashHandler.events.register("hashChanged", hashHandler, function() {
        document.cookie = "osmview="+this.hashHandler.getLocationHash().replace(/;/g, "&")+";expires="+cookieExpiry.toGMTString();
    });
    hashHandler.activate();
}

$(document).ready(function() {
	/* bind to the click to show car profile */
	$('a.j-show-car-profile').live('click', function () {
		$('#dialog-wrapper').load('{% url mfe_cars_detail %}' + $(this).attr('href').substring(4) + '/', function () {
			$('#dialog-wrapper').dialog({
				'title': $(this).find('h2').text(),
				'width': 620,
				'height': 500
			});
		});
		return false;
    });

	/* sliding of car details */
    $('a.j-car-detail-toggler').live('click', function () {
        if ($(this).is('.sort-up')) {
        	$(this).parents('h4').next('.car-map-car-detail-content').slideUp();
        	$(this).removeClass('sort-up').addClass('sort-down');
        } else {
        	$(this).parents('h4').next('.car-map-car-detail-content').slideDown();
        	$(this).removeClass('sort-down').addClass('sort-up');
        }
        return false;
    });

	$(document).mousedown(function () { if (canCloseSearchResults) $('#search-results').hide(); })
	$('#search-results')
		.mouseenter(function () { canCloseSearchResults = false; })
		.mouseleave(function () { canCloseSearchResults = true; });

	$('#search-results a').live('click', function () {
		bboxArr = $(this).attr('href').substring(6).split(',');
		bbox = new OpenLayers.Bounds(
				bboxArr[0], bboxArr[1], bboxArr[2], bboxArr[3])
			.transform(wgs84,smerc),
    	map.zoomToExtent(bbox, true);
		$('#car-search-header form input[type=text]').val($(this).text());
		$('#search-results').hide();
    	return false;
	});
	
    /* search field */
    $('#car-search-header form').submit(function () {
        $.post(
        	'{% url mfe_utils_search %}', 
            { 'q': $(this).find('input[type=text]').val() },
            function (data) {
				var searchResultDiv = $('#search-results');
                
                if (data.length != 0) {
                    if (data.length == 1) {
		                rec = data[0];
		                lonlat = new OpenLayers.LonLat(rec.lon, rec.lat).transform(wgs84, smerc);
		                bbox = new OpenLayers.Bounds(
		    	                rec.boundingbox[2], rec.boundingbox[0], 
		    	                rec.boundingbox[3], rec.boundingbox[1])
		                	.transform(wgs84,smerc),
		            	map.zoomToExtent(bbox, true);
		                $('#car-search-header form input[type=text]').val(rec.display_name);
                    } else {
                        str = '<p>{% trans "Multiple items found" %}:</p><ul class="ul-01">';
						for (i = 0; i < data.length; i++) {
							bboxstr = data[i].boundingbox[2] + ',' + data[i].boundingbox[0] + ',' + data[i].boundingbox[3] + ',' + data[i].boundingbox[1];
							str += '<li><a href="#bbox_' + bboxstr + '">' + data[i].display_name + '</a></li>';
						}
						str += '</ul>';
                    	searchResultDiv
	                    	.html(str)
	                		.slideDown();
                    }
                } else {
                    searchResultDiv
                    	.html('<p><strong>{% trans "Nothing found" %}</strong>.</p>')
                		.slideDown();
                }
            }, 'json'
        );
        return false;
    });
	
    initializeMap();
    selectCtrl = new OpenLayers.Control.SelectFeature(overlays);
    map.addControl(selectCtrl);
    selectCtrl.activate();
});

function handlePopup(feature) {
    if (feature.data['id']) {
        $('#car-details-wrapper').load('{% url mfe_cars_geo_detail %}'
			+ feature.data['id'] + '/', function (data) {
		});
    }
}

function createPOILayer(name, type, icon) {
    var layer = new OpenLayers.Layer.Vector(name, {
        projection: wgs84,
        maxResolution: 6.0,
        alwaysInRange: true,
        visibility: true,
        strategies: [new OpenLayers.Strategy.BBOX({ratio: 2.5})],
        protocol: new OpenLayers.Protocol.HTTP({
        url: '{% url mfe_cars_geo_feed %}' + type + '/',
            format: new OpenLayers.Format.OSMPOI({defaultStyle: {
    				'externalGraphic': '{{ MEDIA_URL }}js/OpenLayers-2.8/img/'+icon,
    				'graphicWidth': 20,
    				'graphicHeight': 20,
    				'graphicXOffset': -10,
    				'graphicYOffset': -10,
    				'graphicOpacity': 1
    			}})
        }),
    });

    layer.events.on({
        featureselected: function(e) {
            handlePopup(e.feature);
        }
    });

    return layer;
}

overlays.push(createPOILayer("car" , "car" , "marker-green.png"));
overlays.push(createPOILayer("parking" , "parking" , "marker-blue.png"));
</script>
{% endblock %}

{% block title %}{% trans "Find cars" %} - {{ block.super }}{% endblock %}


{% block content %}

<div id="cols2-top"></div>
<div id="cols2" class="box">

    <!-- Blog -->
    <div id="col-left">
   			<div class="title">
                <h2>{% trans "Find cars" %}</h2>
            </div>
            
            {% blocktrans %}
            <p>Below you can search for cars in your neighborhood. You can
            get more details by clicking on car sign, which will open car
            details on the right side of the page.</p>
            {% endblocktrans %}
    </div> <!-- /col-left -->

    <hr class="noscreen" />

    <!-- Testimonials -->
    <div id="col-right">
    	{% include "cars/right_col_menu.html" %}
    </div> <!-- /col-right -->
</div> <!-- /cols2 -->
<div id="cols2-bottom"></div>

<hr class="noscreen" />

<div id="car-search-box">
	<div id="car-search-header">
		<h2>{% trans "Car finder" %}</h2>
		<div>
			<form>
				<span class="search"><span><input type="text" style="width: 450px;" value="{% trans "Enter a location or a car type, model etc." %}"></span></span>
				<input type="image" value="OK" src="{{ MEDIA_URL }}img/search-box-submit.png" class="search-submit" />
			</form>
			<div id="search-results" style="display:none;"></div>
		</div>
	</div>
	<div class="inner-2cols">
		<div class="col-left">
			<div id="car-map"></div>
		</div>
		<div class="col-right">
			<div id="car-details-wrapper">
			{% blocktrans %}
			<h4><span>Currently no cars selected</span></h4>
			<p>To start browsing our cars, please refer to map 
			<strong>to the left</strong> of this box. Look for a car 
			in suitable location and show it's details by clicking it's 
			marker.</p>
			{% endblocktrans %}
			</div>
		</div>
	</div>
</div>
<hr class="noscreen" />

<div id="dialog-wrapper" style="display: none;"></div>

{% endblock %}
